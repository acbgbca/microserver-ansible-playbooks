#!/bin/bash

USER_ID=acbgbca
BACKUP_DIR={{ backup_dir }}/repos

# Create backup directory if it does not exist
mkdir -p "$BACKUP_DIR"

# Fetch list of repositories from GitHub API
REPOS=$(curl -s https://api.github.com/users/$USER_ID/repos?per_page=100)

# Loop through each repository and process
for REPO in $(echo $REPOS | jq -r '.[] | select(.fork != true) | .clone_url'); do
    # Extract repo name from URL
    REPO_NAME=$(basename "$REPO" .git)

    # Check if the repository is already cloned
    if [ -d "$BACKUP_DIR/$REPO_NAME" ]; then
        echo "Updating $REPO_NAME..."
        (cd "$BACKUP_DIR/$REPO_NAME"; git remote update)
    else
        echo "Cloning $REPO_NAME..."
        git clone --mirror "$REPO" "$BACKUP_DIR/$REPO_NAME"
    fi
done

echo "Backup completed successfully."